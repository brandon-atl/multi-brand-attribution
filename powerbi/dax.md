-- Base counts
CUSTOMERS := DISTINCTCOUNT('DIM_CUSTOMER'[CustomerID])
CUSTOMERS_FIRST_BASE := DISTINCTCOUNT('VW_FIRST_PURCHASE'[CustomerID])

-- Customers who shopped the selected brand first
CUSTOMERS_FIRST_BRAND :=
VAR SelBrands = VALUES('DIM_BRAND'[BrandCode])
RETURN
  CALCULATE(
    DISTINCTCOUNT('VW_FIRST_PURCHASE'[CustomerID]),
    TREATAS(SelBrands, 'VW_FIRST_PURCHASE'[FIRST_PURCHASE_BRAND])
  )

Pct_Customers_FirstBrand := DIVIDE([CUSTOMERS_FIRST_BRAND], [CUSTOMERS_FIRST_BASE])

-- Time-scoped first-touch denominator (for monthly trend)
CUSTOMERS_FIRST_IN_PERIOD :=
VAR MinD = MIN('Date'[Date])
VAR MaxD = MAX('Date'[Date])
RETURN
  CALCULATE(
    DISTINCTCOUNT('VW_FIRST_PURCHASE'[CustomerID]),
    'VW_FIRST_PURCHASE'[FIRST_ORDER_UTC] >= MinD &&
    'VW_FIRST_PURCHASE'[FIRST_ORDER_UTC] <  MaxD
  )

Pct_FirstBrand_InPeriod :=
VAR SelBrands = VALUES('DIM_BRAND'[BrandCode])
VAR Numerator =
  CALCULATE(
    DISTINCTCOUNT('VW_FIRST_PURCHASE'[CustomerID]),
    TREATAS(SelBrands, 'VW_FIRST_PURCHASE'[FIRST_PURCHASE_BRAND]),
    KEEPFILTERS(
      'VW_FIRST_PURCHASE'[FIRST_ORDER_UTC] >= MIN('Date'[Date]) &&
      'VW_FIRST_PURCHASE'[FIRST_ORDER_UTC] <  MAX('Date'[Date])
    )
  )
RETURN DIVIDE(Numerator, [CUSTOMERS_FIRST_IN_PERIOD])

-- Flows and cannibalization (matrix over VW_BRAND_FLOWS_SUBSEQ)
FLOW_CUSTOMERS := SUM('VW_BRAND_FLOWS_ANY'[CUSTOMERS])
CUSTOMERS_SUBSEQ := SUM('VW_BRAND_FLOWS_SUBSEQ'[CUSTOMERS])

Cannibalization_Rate :=
VAR FromB = SELECTEDVALUE('VW_BRAND_FLOWS_SUBSEQ'[FROM_BRAND])
VAR ToB   = SELECTEDVALUE('VW_BRAND_FLOWS_SUBSEQ'[TO_BRAND])
VAR Moved =
  CALCULATE(
    [CUSTOMERS_SUBSEQ],
    KEEPFILTERS('VW_BRAND_FLOWS_SUBSEQ'[FROM_BRAND]=FromB),
    KEEPFILTERS('VW_BRAND_FLOWS_SUBSEQ'[TO_BRAND]=ToB)
  )
VAR Base =
  CALCULATE(
    DISTINCTCOUNT('VW_FIRST_PURCHASE'[CustomerID]),
    'VW_FIRST_PURCHASE'[FIRST_PURCHASE_BRAND] = FromB
  )
RETURN DIVIDE(Moved, Base)

